# 诊断问题排查指南

## ✅ 修复内容（最新版本）

### 1. **输入对话框高度调整**
- ✅ 对话框最小高度提升到 180pt
- ✅ IP和端口号输入框都能完整显示
- ✅ 不会出现显示不全的情况

### 2. **关闭按钮优化**  
- ✅ 按钮尺寸增大到 **40x40**
- ✅ 实际触摸区域扩展到 **70x70**（含15pt扩展边距）
- ✅ 设置 `clipsToBounds = NO` 允许按钮触摸区域超出边界
- ✅ `zPosition = 1000` 确保按钮在最上层
- ✅ 点击高亮显示深红色，无白色横条

### 3. **诊断日志增强**
- ✅ 添加详细的NSLog调试日志
- ✅ 可以通过Xcode查看SDK内部执行状态
- ✅ 定位DNS、Ping、Traceroute、Telnet各环节问题

---

## 🔍 如何查看诊断日志

### 方法1：Xcode控制台（推荐）

1. 使用Xcode运行项目
2. 打开 **View → Debug Area → Show Debug Area**（或按 `Cmd+Shift+Y`）
3. 点击悬浮按钮，开始诊断
4. 在控制台查找以下日志：

```
[SDK] pingHost 开始，host=www.baidu.com, count=5
[SDK] 开始DNS解析：www.baidu.com
[SDK] DNS解析成功：www.baidu.com -> 110.242.68.66
[SDK] 执行第1次ping...
[SDK] 第1次ping结果: 25.34
[SDK] 执行第2次ping...
...
[SDK] Ping完成，成功:5 失败:0
[SDK] 准备回调Ping结果，长度:458
[SDK] 执行Ping回调
[SDK] Ping回调完成
```

### 方法2：设备日志（物理设备）

1. 连接iPhone到Mac
2. 打开 **Xcode → Window → Devices and Simulators**
3. 选择你的设备
4. 点击 **Open Console**
5. 搜索关键字：`[SDK]`

---

## 🐛 常见问题排查

### 问题1：诊断界面没有任何输出

**可能原因：**
- DNS解析失败
- 网络权限问题
- 回调没有执行

**排查步骤：**

#### 1. 检查日志中是否有DNS解析信息
```
[SDK] 开始DNS解析：www.baidu.com
[SDK] DNS解析成功：www.baidu.com -> 110.242.68.66  ✅ 正常
或
[SDK] DNS解析失败：www.baidu.com  ❌ 异常
```

如果DNS解析失败：
- ✅ 检查设备网络连接
- ✅ 尝试使用纯IP地址（如 `8.8.8.8`）
- ✅ 检查输入的域名是否正确

#### 2. 检查日志中是否有Ping执行信息
```
[SDK] 执行第1次ping...
[SDK] 第1次ping结果: 25.34  ✅ 正常（大于0表示成功）
或
[SDK] 第1次ping结果: -1.00  ⚠️ 超时
或  
[SDK] 第1次ping结果: -2.00  ❌ 连接失败
```

#### 3. 检查回调是否执行
```
[SDK] 准备回调Ping结果，长度:458
[SDK] 执行Ping回调
[SDK] Ping回调完成  ✅ 回调成功
```

如果看到"准备回调"但没有"执行回调"：
- 可能是主线程被阻塞
- 检查DiagnosisViewController的log方法是否正常

---

### 问题2：关闭按钮还是点不到

**检查项：**

1. **悬浮窗是否设置了 `clipsToBounds = YES`**  
   ❌ 错误：会裁剪按钮触摸区域  
   ✅ 正确：应该是 `clipsToBounds = NO`

2. **是否有其他视图遮挡**  
   查看视图层级：Xcode → Debug View Hierarchy

3. **触摸事件是否被拦截**  
   检查是否有手势冲突

**临时解决方案：**
```objective-c
// 如果关闭按钮还是难以点击，可以调整位置让它完全在悬浮窗内部
self.closeButton.frame = CGRectMake(75, 0, 40, 40);  // 向内移动
```

---

### 问题3：输入框显示不全

**已修复内容：**
- 对话框增加了高度约束调整代码
- 设置 `preferredContentSize`

**如果问题依然存在：**

检查iOS版本：
- **iOS 13+**：约束调整方式正常工作
- **iOS 12及以下**：可能需要额外处理

**备选方案（自定义弹窗）：**

如果UIAlertController高度仍然不够，可以改用自定义弹窗：

```objective-c
// 创建一个自定义UIViewController替代UIAlertController
// 可以完全控制高度和布局
```

---

### 问题4：诊断速度太慢

**原因分析：**
- Ping默认5次，每次间隔1秒
- Traceroute默认30跳，每跳超时5秒
- Telnet连接超时5秒

**优化建议：**

```objective-c
// 减少Ping次数
[sdk pingHost:host count:3 callback:^(NSString *result) {
    // ...
}];

// 或者只执行单项诊断
[sdk pingHost:host callback:^(NSString *result) {
    NSLog(@"%@", result);
}];
```

---

## 📱 网络权限检查

### Info.plist 配置

确保项目的 `Info.plist` 包含网络权限：

```xml
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
</dict>
```

**注意：** 正式上架App Store时，需要配置具体的域名而不是使用 `NSAllowsArbitraryLoads`

---

## 🧪 测试建议

### 测试用例1：基本连通性
```objective-c
// 使用公网DNS服务器测试
host: 8.8.8.8
port: 53
```

### 测试用例2：常用网站
```objective-c
host: www.baidu.com
port: 80
```

### 测试用例3：HTTPS端口
```objective-c
host: www.baidu.com
port: 443
```

### 测试用例4：无效地址（测试错误处理）
```objective-c
host: invalid.test.com
port: 80
```

---

## 🚀 下一步

1. **从GitHub Actions下载最新SDK**  
   https://github.com/YuanLin9527/new/actions
   
2. **替换项目中的.a文件和头文件**

3. **运行并查看Xcode控制台日志**

4. **反馈诊断结果**  
   - 如果有错误日志，复制完整的 `[SDK]` 日志
   - 截图诊断界面
   - 说明测试环境（模拟器/真机，iOS版本）

---

## 📋 完整日志示例

**正常执行时的日志：**

```
[SDK] pingHost 开始，host=www.baidu.com, count=5
[SDK] 开始DNS解析：www.baidu.com
[SDK] DNS解析成功：www.baidu.com -> 110.242.68.66
[SDK] 执行第1次ping...
[SDK] 第1次ping结果: 25.34
[SDK] 执行第2次ping...
[SDK] 第2次ping结果: 23.12
[SDK] 执行第3次ping...
[SDK] 第3次ping结果: 24.87
[SDK] 执行第4次ping...
[SDK] 第4次ping结果: 26.45
[SDK] 执行第5次ping...
[SDK] 第5次ping结果: 22.98
[SDK] Ping完成，成功:5 失败:0
[SDK] 准备回调Ping结果，长度:458
[SDK] 执行Ping回调
[SDK] Ping回调完成
```

**DNS解析失败时的日志：**

```
[SDK] pingHost 开始，host=invalid.test.com, count=5
[SDK] 开始DNS解析：invalid.test.com
[SDK] DNS解析失败：invalid.test.com
[SDK] 准备回调Ping结果，长度:85
[SDK] 执行Ping回调
[SDK] Ping回调完成
```

---

## ✉️ 需要帮助？

如果问题依然存在，请提供：

1. **完整的 [SDK] 日志**（从Xcode控制台复制）
2. **诊断界面截图**
3. **测试环境信息**：
   - 设备型号
   - iOS版本
   - 模拟器还是真机
   - 输入的IP/域名和端口

---

**当前版本：** 2025-11-07（包含输入框、关闭按钮、诊断日志修复）

